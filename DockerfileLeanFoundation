#
#   LEAN Foundation Docker Container 20200527
#   Cross platform deployment for multiple brokerages
#   Intended to be used in conjunction with Dockerfile. This is just the foundation common OS+Dependencies required.
#

# Use base system for cleaning up wayward processes
FROM phusion/baseimage:0.9.22

MAINTAINER QuantConnect <contact@quantconnect.com>

# Use baseimage-docker's init system.
CMD ["/sbin/my_init"]

# Have to add env TZ=UTC. See https://github.com/dotnet/coreclr/issues/602
RUN env TZ=UTC

# Install OS Packages:
# Misc tools for running Python.NET and IB inside a headless container.
RUN add-apt-repository ppa:ubuntu-toolchain-r/test && apt-get update
RUN apt-get install -y git bzip2 clang cmake curl unzip wget python3-pip python-opengl zlib1g-dev && \
    apt-get install -y xvfb libxrender1 libxtst6 libxi6 libglib2.0-dev libopenmpi-dev libstdc++6 openmpi-bin && \
# Install R
    apt-get install -y r-base pandoc libcurl4-openssl-dev

# Java for running IB inside container:
RUN apt-get install -y openjdk-8-jdk openjdk-8-jre

# Install IB Gateway: Installs to ~/Jts
RUN wget http://cdn.quantconnect.com/interactive/ibgateway-latest-standalone-linux-x64-v974.4g.sh && \
    chmod 777 ibgateway-latest-standalone-linux-x64-v974.4g.sh && \
    ./ibgateway-latest-standalone-linux-x64-v974.4g.sh -q && \
    wget -O ~/Jts/jts.ini http://cdn.quantconnect.com/interactive/ibgateway-latest-standalone-linux-x64-v974.4g.jts.ini && \
    rm ibgateway-latest-standalone-linux-x64-v974.4g.sh

# Mono C# for LEAN:
# From https://github.com/mono/docker/blob/master/
RUN apt-get update && rm -rf /var/lib/apt/lists/*
RUN apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
RUN echo "deb http://download.mono-project.com/repo/ubuntu stable-xenial/snapshots/5.12.0.226 main" > /etc/apt/sources.list.d/mono-xamarin.list && \
    apt-get update && apt-get install -y binutils mono-complete ca-certificates-mono mono-vbnc nuget referenceassemblies-pcl && \
    apt-get install -y fsharp && rm -rf /var/lib/apt/lists/* /tmp/*

# Install miniconda
ENV CONDA="Miniconda3-4.5.12-Linux-x86_64.sh"
ENV PATH="/opt/miniconda3/bin:${PATH}"
RUN wget https://cdn.quantconnect.com/miniconda/${CONDA} && \
    bash ${CONDA} -b -p /opt/miniconda3 && rm -rf ${CONDA} && \
    ln -s /opt/miniconda3/lib/libpython3.6m.so /usr/lib/libpython3.6m.so

# Install supported third party python packages
# Updates conda and pip
RUN conda update -y conda pip

# Updates pip
RUN pip install --upgrade pip

# Sets python version to 3.6.8
RUN conda install -y python=3.6.8
RUN conda clean -y --all

# Install essencial packages
RUN conda install -y                \
    cython=0.29.17                  \
    numpy=1.18.1                    \
    pandas=0.25.3                   \
    wrapt=1.12.1

# Install non-math packages
RUN conda install -y                \
    astropy=4.0.1.post1             \
    beautifulsoup4=4.9.0            \
    blaze=0.11.3                    \
    dill=0.3.1.1                    \
    jsonschema=3.2.0                \
    lxml=4.5.0                      \
    msgpack-python=1.0.0            \
    numba=0.46                      \
    setuptools-git=1.2              \
    xarray=0.15.1 

RUN conda install -y -c plotly      \
    plotly=4.7.1

RUN conda install -y -c conda-forge \
    jupyterlab=2.1.2

# Install TensorFlow 1.15.2
RUN conda install -y -c intel       \
    tensorflow==1.15.2

# Install math/ML packages
RUN conda install -y                \
    docutils=0.14                   \
    cvxopt=1.2.0                    \
    gensim=3.8.0                    \
    keras=2.3.1                     \
    lightgbm=2.3.0                  \
    mpi4py=3.0.3                    \
    nltk=3.4.5                      \
    pomegranate=0.11.1              \
    tensorflow-base=1.15.0          \
    python-graphviz=0.8.4

# Install requirement for fbprophet
RUN pip install cmdstanpy==0.4

# Install math/ML from conda-forge
RUN conda install -y -c conda-forge \
    copulae=0.3.1                   \ 
    featuretools=0.14.0             \
    fbprophet=0.6                   \
    openmpi=4.0.3                   \
    pulp=1.6.8                      \
    pymc3=3.8                       \
    rauth=0.7.3                     \
    scikit-learn=0.21.3             \
    scikit-multiflow=0.4.1          \
    scikit-optimize=0.7.4           \
    theano=1.0.4                    \
    tsfresh=0.15.1                  \
    tslearn=0.3.1                   \
    tweepy=3.8.0                    \
    pywavelets=1.1.1                \
    umap-learn=0.4.3

# Install math/ML from pytorch
RUN conda install -y -c pytorch     \
    pytorch=1.5.0                   \
    torchvision=0.6.0

# Install math/ML from fastai
RUN conda install -y -c fastai      \
    nvidia-ml-py3=7.352.0           \
    fastai=1.0.61

RUN conda clean -y --all

# Install from PIP I
RUN pip install arch==4.14          \
    copulalib==1.1.0                \
    copulas==0.3.0                  \
    creme==0.5.1                    \
    cufflinks==0.17.3               \
    gym==0.17.2                     \
    ipywidgets==7.5.1

# Install from PIP II
RUN pip install deap==1.3.1         \
    cvxpy==1.0.31                   \
    mlfinlab==0.10.0                \
    pykalman==0.9.5                 \
    pyportfolioopt==1.2.2           \
    pyramid-arima==0.9.0            \
    pyro-ppl==1.3.1                 \
    riskparityportfolio==0.2

# Install from PIP III
RUN pip install sklearn==0.0        \
    sklearn-json==0.1.0             \
    stable-baselines==2.10.0        \
    statistics==1.0.3.5             \
    statsmodels==0.11.1             \
    tensorforce==0.5.4              \
    QuantLib-Python==1.18           \
    xgboost==1.1.0                  \
    dtw-python==1.0.5

# Install from PIP IV
RUN pip install cntk==2.7           \
    mxnet==1.6                      \
    gluonts==0.5.0                  \
    gplearn==0.4.1                  \
    jax==0.1.68                     \
    jaxlib==0.1.47                  \
    keras-rl==0.4.2                 \
    pennylane==0.9.0

# Install from PIP V
RUN pip install catboost==0.23.2    \
    fastai2==0.0.17                 \
    ppscore==0.0.2                  \
    scikit-tda==0.0.3

# Install Google Neural Tangents after JAX
RUN pip install neural-tangents==0.2.1

RUN pip install --upgrade mplfinance==0.12.4a0
RUN pip install --upgrade hmmlearn==0.2.3
RUN python -m nltk.downloader -d /usr/share/nltk_data punkt
RUN python -m nltk.downloader -d /usr/share/nltk_data vader_lexicon

# Update ODO
RUN conda remove --force-remove -y odo
RUN pip install git+git://github.com/blaze/odo.git@9fce6690b3666160681833540de6c55e922de5eb

# Install DX Analytics
RUN pip install git+git://github.com/yhilpisch/dx.git@4c47c258acddf966be5082530764d8115831dcb3

# Install Auto-KS
RUN pip install git+git://github.com/cvxgrp/auto_ks.git@b39e8f39eec33d6c55a92e2a781d62a8439f32a6

# Install Pyrb
RUN pip install git+git://github.com/jcrichard/pyrb.git@d02b56ae91f67b73f39e5e474fa90b0523f6638b

# Install SSM
RUN pip install git+git://github.com/slinderman/ssm.git@9fd66aeddf74059c934c8b214f8f7757b9bef214

# Install TA-lib for python
RUN wget http://cdn.quantconnect.com/ta-lib/ta-lib-0.4.0-src.tar.gz && \
    tar -zxvf ta-lib-0.4.0-src.tar.gz && cd ta-lib && \
    ./configure --prefix=/usr && make && make install && \
    wget https://github.com/mrjbq7/ta-lib/archive/TA_Lib-0.4.18.zip && \
    unzip -q TA_Lib-0.4.18.zip && cd ta-lib-TA_Lib-0.4.18 && \
    python setup.py install && cd ../.. && rm -irf ta-lib

# Install py-earth
RUN wget https://github.com/scikit-learn-contrib/py-earth/archive/0.1.0.zip && \
    unzip -q 0.1.0.zip && cd py-earth-0.1.0 && \
    python setup.py install && cd .. && rm -irf py-earth-0.1.0

# Install fastText
RUN wget https://github.com/facebookresearch/fastText/archive/v0.9.2.zip && \
    unzip -q v0.9.2.zip && cd fastText-0.9.2 && \
    python setup.py install && cd .. && rm -irf fastText-0.9.2

# Install Tigramite
RUN wget https://github.com/jakobrunge/tigramite/archive/4.1.zip && \ 
    unzip -q 4.1.zip && cd tigramite-4.1 && \
    python setup.py install && cd .. && rm -irf tigramite-4.1

# Install H2O: https://www.h2o.ai/download/
RUN wget https://cdn.quantconnect.com/h2o/h2o-3.30.0.3.zip && \
    unzip -q h2o-3.30.0.3.zip && \
    pip install h2o-3.30.0.3/python/h2o-3.30.0.3-py2.py3-none-any.whl && \
    rm -irf h2o-3.30.0.3

# Delete temporary zip files
RUN rm -irf *.zip *.gz

# Remove black-listed packages
RUN pip uninstall -y s3transfer
RUN conda remove --force-remove -y s3transfer
RUN conda clean -y --all

# List all packages
RUN conda list